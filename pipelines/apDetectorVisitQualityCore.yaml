description: |
  Tier 1 AP plots and metrics to assess CcdVisit quality
tasks:
  analyzeAssocDiaSrcCore:
    class: lsst.analysis.tools.tasks.AssocDiaSrcDetectorVisitAnalysisTask
    config:
      # atools.numDiaSources: NumDiaSourcesMetric
      atools.numDiaSourcesAll: NumDiaSourcesSelectionMetric
      atools.numDiaSourcesAll.metricName: numDiaSourcesAll
      atools.numDiaSourcesAll.process.calculateActions.countingAction.vectorKey: diaSourceId
      atools.numDipoles: NumDipolesMetric
      atools.numSsObjects: NumSsObjectsMetric
      atools.numDiaSourcesHighReliability: NumDiaSourcesSelectionMetric
      atools.numDiaSourcesHighReliability.metricName: numDiaSourcesHighReliability
      atools.numDiaSourcesHighReliability.process.calculateActions.countingAction.op: gt
      atools.numDiaSourcesHighReliability.process.calculateActions.countingAction.threshold: 0.9
      atools.numDiaSourcesHighReliability.process.calculateActions.countingAction.vectorKey: reliability
      atools.numDiaSourcesLowReliability: NumDiaSourcesSelectionMetric
      atools.numDiaSourcesLowReliability.metricName: numDiaSourcesLowReliability
      atools.numDiaSourcesLowReliability.process.calculateActions.countingAction.op: lt
      atools.numDiaSourcesLowReliability.process.calculateActions.countingAction.threshold: 0.1
      atools.numDiaSourcesLowReliability.process.calculateActions.countingAction.vectorKey: reliability
      atools.numDiaSourcesNanReliability: NumDiaSourcesSelectionMetric
      atools.numDiaSourcesNanReliability.metricName: numDiaSourcesNanReliability
      atools.numDiaSourcesNanReliability.process.calculateActions.countingAction.op: eq
      atools.numDiaSourcesNanReliability.process.calculateActions.countingAction.threshold: !!float nan
      atools.numDiaSourcesNanReliability.process.calculateActions.countingAction.vectorKey: reliability
      atools.diaSourcesGoodVsBadRatio: DiaSourcesGoodVsBadRatioMetric
      connections.outputName: assocDiaSrcCore
      atools.simpleSky: SimpleDiaPlot
      python: |
        from lsst.analysis.tools.atools import *
  analyzeTrailedDiaSrcCore:
    class: lsst.analysis.tools.tasks.TrailedDiaSrcDetectorVisitAnalysisTask
    config:
      # Counts up the number of dia sources in the trailed table.
      atools.numDiaSourcesAll: NumDiaSourcesAllMetric
      connections.outputName: trailedDiaSrcCore
      python: |
        from lsst.analysis.tools.atools import *
  diffimTaskCore:
    class: lsst.analysis.tools.tasks.DiffimDetectorVisitAnalysisTask
    config:
      connections.outputName: diffimMetadata

      atools.diffimMetadataMetric: DiffimMetadataMetricTool
      atools.diffimMetadataMetric.metrics:
        # Format is "metric name in the metadata": units
        nUnmergedDiaSources: ct
        nMergedDiaSources: ct
        nGoodPixels: ct
        nBadPixels: ct
        nPixelsDetectedPositive: ct
        nPixelsDetectedNegative: ct
        nBadPixelsDetectedPositive: ct
        nBadPixelsDetectedNegative: ct
        sciencePsfSize: pixel
        templatePsfSize: pixel
        scaleScienceVarianceFactor: ct
        scaleTemplateVarianceFactor: ct
        templateCoveragePercent: percent
      python: |
        from lsst.analysis.tools.atools import DiffimMetadataMetricTool

  fluxHist:
    class: lsst.analysis.tools.tasks.allDiaSourceAnalysis.AllDiaSourceHistTask
    config:
      connections.fakesType: "fakes_"
  fluxAnalysis:
    class: lsst.analysis.tools.tasks.allDiaSourceAnalysis.AllDiaSourceAnalysisTask
    config:
      atools.plotPsfFluxHistSrc: PlotPsfFluxHistSrc
      python: |
        from lsst.analysis.tools.atools import *
    # class: lsst.analysis.tools.tasks.AssocDiaSrcDetectorVisitAnalysisTask
    # config:
      #connections.data: "fakes_goodSeeingDiff_assocDiaSrc"
      # connections.fakesType: "fakes_"
      # connections.outputName: "visitPlot"

      # atools.plotFluxHistSrc: PlotFluxHistSrc
      # python: |
      #   from lsst.analysis.tools.atools import PlotFluxHistSrc