description: |
  AP plots and metrics to assess CcdVisit quality in Prompt Processing
  Additional AP metrics may be written in apDetectorVisitQualityExtended
parameters:
  # Note that these parameter names are shared with ApPipe, and are overwritten
  # by changes in the values there.
  coaddName: goodSeeing
  fakesType: ''
tasks:
  analyzeAssocDiaSrcCore:
    class: lsst.analysis.tools.tasks.AssocDiaSrcDetectorVisitAnalysisTask
    config:
      atools.numDiaSources: NumDiaSourcesMetric
      atools.numDiaSourcesAll: NumDiaSourcesSelectionMetric
      atools.numDiaSourcesAll.metricName: numDiaSourcesAll
      atools.numDiaSourcesAll.process.calculateActions.countingAction.vectorKey: diaSourceId
      atools.numDiaSourcesGood: NumGoodDiaSourcesMetrics
      atools.numDipoles: NumDipolesMetric
      atools.numSsObjects: NumSsObjectsMetric
      atools.numDiaSourcesHighReliability: NumDiaSourcesSelectionMetric
      atools.numDiaSourcesHighReliability.metricName: numDiaSourcesHighReliability
      atools.numDiaSourcesHighReliability.process.calculateActions.countingAction.op: gt
      atools.numDiaSourcesHighReliability.process.calculateActions.countingAction.threshold: 0.9
      atools.numDiaSourcesHighReliability.process.calculateActions.countingAction.vectorKey: reliability
      atools.numDiaSourcesLowReliability: NumDiaSourcesSelectionMetric
      atools.numDiaSourcesLowReliability.metricName: numDiaSourcesLowReliability
      atools.numDiaSourcesLowReliability.process.calculateActions.countingAction.op: lt
      atools.numDiaSourcesLowReliability.process.calculateActions.countingAction.threshold: 0.1
      atools.numDiaSourcesLowReliability.process.calculateActions.countingAction.vectorKey: reliability
      atools.numDiaSourcesNanReliability: NumDiaSourcesSelectionMetric
      atools.numDiaSourcesNanReliability.metricName: numDiaSourcesNanReliability
      atools.numDiaSourcesNanReliability.process.calculateActions.countingAction.op: eq
      atools.numDiaSourcesNanReliability.process.calculateActions.countingAction.threshold: !!float nan
      atools.numDiaSourcesNanReliability.process.calculateActions.countingAction.vectorKey: reliability
      # TODO DM-43401 to support a denominator of 0
      # atools.diaSourcesGoodVsBadRatio: DiaSourcesGoodVsBadRatioMetric
      connections.outputName: assocDiaSrcCore
      connections.coaddName: parameters.coaddName
      connections.fakesType: parameters.fakesType
      # TODO DM-43201 fix this
      # atools.simpleSky: SimpleDiaPlot
      python: |
        from lsst.analysis.tools.atools import *
  analyzeTrailedDiaSrcCore:
    class: lsst.analysis.tools.tasks.TrailedDiaSrcDetectorVisitAnalysisTask
    config:
      # Counts up the number of dia sources in the trailed table.
      connections.outputName: trailedDiaSrcCore
      atools.numDiaSourcesAll: NumDiaSourcesSelectionMetric
      atools.numDiaSourcesAll.metricName: numTrailedDiaSrc
      atools.numDiaSourcesAll.process.calculateActions.countingAction.vectorKey: id
      connections.coaddName: parameters.coaddName
      connections.fakesType: parameters.fakesType
      python: |
        from lsst.analysis.tools.atools import *
  diffimTaskCore:
    class: lsst.analysis.tools.tasks.DiffimDetectorVisitMetricsAnalysisTask
    config:
      connections.outputName: diffimMetadata

      atools.diffimMetadataMetric: DiffimMetadataMetricTool
      atools.diffimMetadataMetric.metrics:
        # Format is "metric name in the metadata": units
        nUnmergedDiaSources: ct
        nMergedDiaSources: ct
        nGoodPixels: ct
        nBadPixels: ct
        nPixelsDetectedPositive: ct
        nPixelsDetectedNegative: ct
        nBadPixelsDetectedPositive: ct
        nBadPixelsDetectedNegative: ct
        sciencePsfSize: pixel
        templatePsfSize: pixel
        scaleScienceVarianceFactor: ct
        scaleTemplateVarianceFactor: ct
        templateCoveragePercent: percent
      python: |
        from lsst.analysis.tools.atools import DiffimMetadataMetricTool
  diffimTaskPlots:
    class: lsst.analysis.tools.tasks.DiffimDetectorVisitSpatiallySampledPlotsTask
    config:
      connections.outputName: diffimPlots
      connections.fakesType: parameters.fakesType
      connections.coaddName: parameters.coaddName
      atools.diaFlagHistogram: DiffimSpatialMetricsHistPlot
      atools.interpolatedDipoleDensity: DiffimSpatialMetricsInterpolatePlot
      atools.interpolatedDipoleDensity.metricName: dipole_density
      atools.interpolatedDipoleDensity.produce.plot.zAxisLabel: Number/degree^2
      atools.interpolatedSourceDensity: DiffimSpatialMetricsInterpolatePlot
      atools.interpolatedSourceDensity.metricName: source_density
      atools.interpolatedSourceDensity.produce.plot.zAxisLabel: Number/degree^2
      atools.interpolatedTemplateMedian: DiffimSpatialMetricsInterpolatePlot
      atools.interpolatedTemplateMedian.metricName: template_value
      atools.interpolatedTemplateMedian.produce.plot.zAxisLabel: nJy
      atools.interpolatedScienceMedian: DiffimSpatialMetricsInterpolatePlot
      atools.interpolatedScienceMedian.metricName: science_value
      atools.interpolatedScienceMedian.produce.plot.zAxisLabel: nJy
      atools.interpolatedDiffimMedian: DiffimSpatialMetricsInterpolatePlot
      atools.interpolatedDiffimMedian.metricName: diffim_value
      atools.interpolatedDiffimMedian.produce.plot.zAxisLabel: nJy
      atools.interpolatedSciencePsfSize: DiffimSpatialMetricsInterpolatePlot
      atools.interpolatedSciencePsfSize.metricName: science_psfSize
      atools.interpolatedSciencePsfSize.produce.plot.zAxisLabel: pixels
      atools.interpolatedTemplatePsfSize: DiffimSpatialMetricsInterpolatePlot
      atools.interpolatedTemplatePsfSize.metricName: template_psfSize
      atools.interpolatedTemplatePsfSize.produce.plot.zAxisLabel: pixels
      python: |
        from lsst.analysis.tools.atools import DiffimSpatialMetricsHistPlot, DiffimSpatialMetricsInterpolatePlot
  diffimTaskSkySourcePlots:
    class: lsst.analysis.tools.tasks.DiaSourceDetectorVisitAnalysisTask
    config:
      connections.outputName: diffimSkySourcePlots
      connections.coaddName: parameters.coaddName
      connections.fakesType: parameters.fakesType
      atools.diaSkySourceHistPlot: DiaSkySourceHistPlot
      atools.diaSkySourceSkyPlot: DiaSkySourceSkyPlot
      python: |
        from lsst.analysis.tools.atools import DiaSkySourceHistPlot, DiaSkySourceSkyPlot
  initialPviCore:
    class: lsst.analysis.tools.tasks.CalexpSummaryAnalysisTask
    config:
      atools.initialPviSummaryMetrics: CalexpSummaryMetrics
      connections.data: initial_pvi.summaryStats
      connections.outputName: initialPviSummary
      python: from lsst.analysis.tools.atools import *
subsets:
  promptQaMetrics:
    subset:
      - analyzeAssocDiaSrcCore
      - analyzeTrailedDiaSrcCore
      - diffimSourcePlots
      - diffimTaskCore
      - diffimTaskPlots
      - diffimTaskSkySourcePlots
      - initialPviCore
    description: >
      QA metrics to run in Prompt Processing.
